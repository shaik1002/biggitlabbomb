<script>
import { GlAlert } from '@gitlab/ui';
import { __ } from '~/locale';
import WikiPageQuery from '~/wikis/graphql/wiki_page.query.graphql';
import OrderedLayout from '~/notes/components/ordered_layout.vue';
import SkeletonNote from '~/vue_shared/components/notes/skeleton_note.vue';
import { convertToGraphQLId } from '~/graphql_shared/utils';
import { TYPENAME_PROJECT } from '~/graphql_shared/constants';
import PlaceholderNote from './placeholder_note.vue';
import WikiNotesActivityHeader from './wiki_notes_activity_header.vue';
import WikiCommentForm from './wiki_comment_form.vue';
import WikiDiscussion from './wiki_discussion.vue';

export default {
  i18n: {
    loadingFailedErrText: __(
      'Something went wrong while fetching comments. Please refresh the page.',
    ),
    retryText: __('Retry'),
    renderingCommentsFailed: __('The comments for this wiki page failed to render.'),
  },
  name: 'WikiNotesApp',
  components: {
    GlAlert,
    WikiCommentForm,
    WikiDiscussion,
    WikiNotesActivityHeader,
    OrderedLayout,
    SkeletonNote,
    PlaceholderNote,
  },
  inject: ['pageInfo', 'containerId', 'containerType'],
  data() {
    return {
      wikiPage: {},
      noteableId: '',
      loadingFailed: false,
      placeholderNote: {},
      discussions: Array.from({ length: 5 }, (_, index) => ({
        id: index,
        isSkeletonNote: true,
      })),
    };
  },
  computed: {
    slotKeys() {
      return ['comments', 'place-holder-note', 'form'];
    },
  },
  mounted() {
    this.fetchDiscussions();
  },
  methods: {
    async fetchDiscussions() {
      const {
        pageInfo: { slug },
        containerId,
        containerType,
      } = this;

      let variables = {};
      if (containerType === 'project') {
        variables = {
          slug,
          projectId: convertToGraphQLId(TYPENAME_PROJECT, containerId),
        };
      } else if (containerType === 'group') {
        variables = {
          slug,
          namespaceId: convertToGraphQLId(TYPENAME_PROJECT, containerId),
        };
      }

      return this.$apollo
        .query({
          query: WikiPageQuery,
          variables,
        })
        .then(({ data: { wikiPage } }) => {
          this.loadingFailed = false;
          this.noteableId = wikiPage?.id;
          this.discussions = wikiPage?.discussions?.nodes;
        })
        .catch(() => {
          this.loadingFailed = true;
          this.discussions = [];
        });
    },
    setPlaceHolderNote(note) {
      this.placeholderNote = note;
    },
    removePlaceholder() {
      this.placeholderNote = {};
    },
    async updateDiscussions(discussion) {
      this.discussions = [
        ...this.discussions,
        {
          ...discussion,
          replyId: discussion.id,
          resolvable: false,
          resolved: false,
          resolvedAt: null,
          resolvedBy: null,
        },
      ];
    },
    getDiscussionKey(key, stringModifier) {
      return [key, stringModifier].join('-');
    },
  },
};
</script>
<template>
  <div>
    <wiki-notes-activity-header />
    <ordered-layout :slot-keys="slotKeys">
      <template #form>
        <wiki-comment-form
          :noteable-id="noteableId"
          :note-id="containerId"
          :discussions="discussions"
          @creating-note:start="setPlaceHolderNote"
          @creating-note:done="removePlaceholder"
          @creating-note:success="updateDiscussions"
        />
      </template>
      <template v-if="!!placeholderNote.body" #place-holder-note>
        <ul class="notes main-notes-list timeline">
          <placeholder-note :note="placeholderNote" />
        </ul>
      </template>
      <template #comments>
        <gl-alert
          v-if="loadingFailed"
          :dismissible="false"
          variant="danger"
          :primary-button-text="$options.i18n.retryText"
          @primaryAction="fetchDiscussions()"
        >
          {{ $options.i18n.loadingFailedErrText }}
        </gl-alert>
        <ul v-else id="notes-list" class="notes main-notes-list timeline">
          <template v-for="discussion in discussions">
            <skeleton-note
              v-if="discussion.isSkeletonNote"
              :key="getDiscussionKey(discussion.id, 'skeleton')"
              class="note-skeleton"
            />
            <wiki-discussion
              v-else
              :key="getDiscussionKey(discussion.id, 'discussion')"
              :noteable-id="noteableId"
              :discussion="discussion.notes.nodes"
            />
          </template>
        </ul>
      </template>
    </ordered-layout>
  </div>
</template>
