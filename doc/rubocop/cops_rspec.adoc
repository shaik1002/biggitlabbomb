////
  Do NOT edit this file by hand directly, as it is automatically generated.

  Please make any necessary changes to the cop documentation within the source files themselves.
////

= RSpec

[#rspecanyinstanceof]
== RSpec/AnyInstanceOf

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| Always
| -
| -
|===

This cop checks for `allow_any_instance_of` or `expect_any_instance_of`
usage in specs.

[#examples-rspecanyinstanceof]
=== Examples

[source,ruby]
----
# bad
allow_any_instance_of(User).to receive(:invalidate_issue_cache_counts)

# bad
expect_any_instance_of(User).to receive(:invalidate_issue_cache_counts)

# good
allow_next_instance_of(User) do |instance|
  allow(instance).to receive(:invalidate_issue_cache_counts)
end

# good
expect_next_instance_of(User) do |instance|
  expect(instance).to receive(:invalidate_issue_cache_counts)
end
----

[#rspecavoidconditionalstatements]
== RSpec/AvoidConditionalStatements

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

This cop checks for the usage of conditional statements in specs.

https://gitlab.com/gitlab-org/gitlab/-/issues/410138

# bad

  page.has_css?('[data-testid="begin-commit-button"]') ? find('[data-testid="begin-commit-button"]').click : nil

  if page.has_css?('[data-testid="begin-commit-button"]')
    find('[data-testid="begin-commit-button"]').click
  end

  unless page.has_css?('[data-testid="begin-commit-button"]')
    find('[data-testid="begin-commit-button"]').click
  end

[#rspecavoidtestprof]
== RSpec/AvoidTestProf

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

This cop checks for the usage of TestProf methods in migration specs.

[#examples-rspecavoidtestprof]
=== Examples

[source,ruby]
----
# bad
let_it_be(:user) { table(:users).create(username: 'test') }
let_it_be_with_reload(:user) { table(:users).create(username: 'test') }
let_it_be_with_refind(:user) { table(:users).create(username: 'test') }

before_all do
  do_something
end

# good
let(:user) { table(:users).create(username: 'test') }
let!(:user) { table(:users).create(username: 'test') }

before(:all) do
  do_something
end

before do
  do_something
end
----

[#rspecbesuccessmatcher]
== RSpec/BeSuccessMatcher

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| Always
| -
| -
|===

This cop checks for `be_success` usage in controller specs

[#examples-rspecbesuccessmatcher]
=== Examples

[source,ruby]
----
# bad
it "responds with success" do
  expect(response).to be_success
end

it { is_expected.to be_success }

# good
it "responds with success" do
  expect(response).to be_successful
end

it { is_expected.to be_successful }
----

[#rspecbeforeall]
== RSpec/BeforeAll

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| Always
| -
| -
|===

This cop checks for `before(:all) in RSpec tests`

[#examples-rspecbeforeall]
=== Examples

[source,ruby]
----
bad

before(:all) do
  project.repository.add_tag(user, 'v1.2.3', 'master')
end

good

before_all do
  project.repository.add_tag(user, 'v1.2.3', 'master')
end
----

[#rspecbeforeallroleassignment]
== RSpec/BeforeAllRoleAssignment

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Checks for let_it_be with before instead of before_all when using `add_*` methods

[#examples-rspecbeforeallroleassignment]
=== Examples

[source,ruby]
----
# bad
let_it_be(:project) { create(:project) }
let_it_be(:guest) { create(:user) }

before do
  project.add_guest(guest)
end

# good
let_it_be(:project) { create(:project) }
let_it_be(:guest) { create(:user) }

before_all do
  project.add_guest(guest)
end
----

[#rspecduplicatespeclocation]
== RSpec/DuplicateSpecLocation

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that detects duplicate EE spec files

There should not be files in both ee/spec/*/ee/my_spec.rb and ee/spec/*/my_spec.rb

 # bad
 ee/spec/controllers/my_spec.rb      # describe MyClass
 ee/spec/controllers/ee/my_spec.rb   # describe MyClass

 # good, spec for EE extension code
 ee/spec/controllers/ee/my_spec.rb   # describe MyClass

 # good, spec for EE only code
 ee/spec/controllers/my_spec.rb      # describe MyClass

[#rspecenvassignment]
== RSpec/EnvAssignment

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| Always
| -
| -
|===

This cop checks for ENV assignment in specs

[#examples-rspecenvassignment]
=== Examples

[source,ruby]
----
# bad
before do
  ENV['FOO'] = 'bar'
end

# good
before do
  stub_env('FOO', 'bar')
end
----

[#rspecenvmocking]
== RSpec/EnvMocking

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| Always
| -
| -
|===

Check for ENV mocking in specs.
See https://docs.gitlab.com/ee/development/testing_guide/best_practices.html#persistent-in-memory-application-state

[#examples-rspecenvmocking]
=== Examples

[source,ruby]
----
# bad
allow(ENV).to receive(:[]).with('FOO').and_return('bar')
allow(ENV).to receive(:fetch).with('FOO').and_return('bar')
allow(ENV).to receive(:[]).with(key).and_return(value)
allow(ENV).to receive(:[]).with(fetch_key(object)).and_return(fetch_value(object))

# good
stub_env('FOO', 'bar')
stub_env(key, value)
stub_env(fetch_key(object), fetch_value(object))
----

[#rspecexpectgitlabtracking]
== RSpec/ExpectGitlabTracking

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

This cop checks for `expect(Gitlab::Tracking).to receive(:event)` usage in specs.
See /spec/support/helpers/snowplow_helpers.rb for details on the replacement.

# bad
it 'expects a snowplow event' do
  expect(Gitlab::Tracking).to receive(:event).with("Category", "action", ...)
end

# good
it 'expects a snowplow event', :snowplow do
  expect_snowplow_event(category: "Category", action: "action", ...)
end

# bad
it 'does not expect a snowplow event' do
  expect(Gitlab::Tracking).not_to receive(:event)
end

# good
it 'does not expect a snowplow event', :snowplow do
  expect_no_snowplow_event
end

[#rspecfactoriesinmigrationspecs]
== RSpec/FactoriesInMigrationSpecs

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

This cop checks for the usage of factories in migration specs

[#examples-rspecfactoriesinmigrationspecs]
=== Examples

[source,ruby]
----
# bad
let(:user) { create(:user) }

# good
let(:users) { table(:users) }
let(:user) { users.create!(name: 'User 1', username: 'user1') }
----

[#rspecfeaturecategory]
== RSpec/FeatureCategory

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Ensures that feature categories in specs are present and valid.

[#examples-rspecfeaturecategory]
=== Examples

[source,ruby]
----
# bad
RSpec.describe 'foo' do
end

RSpec.describe 'foo', feature_category: :invalid do
  context 'a context', feature_category: :aip do
  end
end

RSpec.describe 'foo', feature_category: :not_owned do
end

# good

RSpec.describe 'foo', feature_category: :wiki do
  context 'a context', feature_category: :api do
  end
end

RSpec.describe 'foo', feature_category: :tooling do
end
----

[#rspechttpartybasicauth]
== RSpec/HTTPartyBasicAuth

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| Always
| -
| -
|===

This cop checks for invalid credentials passed to HTTParty

[#examples-rspechttpartybasicauth]
=== Examples

[source,ruby]
----
# bad
HTTParty.get(url, basic_auth: { user: 'foo' })

# good
HTTParty.get(url, basic_auth: { username: 'foo' })
----

[#rspechavegitlabhttpstatus]
== RSpec/HaveGitlabHttpStatus

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| Always
| -
| -
|===

This cops checks for `have_http_status` usages in specs.
It also discourages the usage of numeric HTTP status codes in
`have_gitlab_http_status`.

# bad
expect(response).to have_http_status(200)
expect(response).to have_http_status(:ok)
expect(response).to have_gitlab_http_status(200)
expect(response.status).to eq(200)
expect(response.status).not_to eq(200)

# good
expect(response).to have_gitlab_http_status(:ok)
expect(response).not_to have_gitlab_http_status(:ok)

[#rspecmisspelledaggregatefailures]
== RSpec/MisspelledAggregateFailures

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| Always
| -
| -
|===

No documentation

[#rspecmodifysidekiqmiddleware]
== RSpec/ModifySidekiqMiddleware

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| Always
| -
| -
|===

This cop checks for `Sidekiq::Testing.server_middleware`
usage in specs.

[#examples-rspecmodifysidekiqmiddleware]
=== Examples

[source,ruby]
----
# bad
Sidekiq::Testing.server_middleware do |chain|
  chain.add(MyMiddlewareUnderTest)
end

# good
with_custom_sidekiq_middleware do |chain|
  chain.add(MyMiddlewareUnderTest)
end
----

[#rspecsharedgroupsmetadata]
== RSpec/SharedGroupsMetadata

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Ensures that shared examples and shared context don't have any metadata.

[#examples-rspecsharedgroupsmetadata]
=== Examples

[source,ruby]
----
# bad
RSpec.shared_examples 'an external link with rel attribute', feature_category: :team_planning do
end

RSpec.shared_examples 'an external link with rel attribute', :aggregate_failures do
end

RSpec.shared_context 'an external link with rel attribute', :aggregate_failures do
end

# good
RSpec.shared_examples 'an external link with rel attribute' do
end

shared_examples 'an external link with rel attribute' do
end

it 'adds rel="nofollow" to external links', feature_category: :team_planning do
end
----

[#rspectopleveldescribepath]
== RSpec/TopLevelDescribePath

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#rspecwebmockenable]
== RSpec/WebMockEnable

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| Always
| -
| -
|===

No documentation
