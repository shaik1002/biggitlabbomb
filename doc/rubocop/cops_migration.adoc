////
  Do NOT edit this file by hand directly, as it is automatically generated.

  Please make any necessary changes to the cop documentation within the source files themselves.
////

= Migration

[#migrationaddcolumnstowidetables]
== Migration/AddColumnsToWideTables

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that prevents adding columns to wide tables.

[#migrationaddconcurrentforeignkey]
== Migration/AddConcurrentForeignKey

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if `add_concurrent_foreign_key` is used instead of
`add_foreign_key`.

[#migrationaddconcurrentindex]
== Migration/AddConcurrentIndex

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if `add_concurrent_index` is used with `up`/`down` methods
and not `change`.

[#migrationaddindex]
== Migration/AddIndex

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if indexes are added in a concurrent manner.

[#migrationaddlimittotextcolumns]
== Migration/AddLimitToTextColumns

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that enforces always adding a limit on text columns

Text columns starting with `encrypted_` are very likely used
by `attr_encrypted` which controls the text length. Those columns
should not add a text limit.

[#migrationaddreference]
== Migration/AddReference

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

add_reference can only be used with newly created tables.
Additionally, the cop here checks that we create an index for the foreign key, too.

[#migrationaddtimestamps]
== Migration/AddTimestamps

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if 'add_timestamps' method is called with timezone information.

[#migrationasyncpostmigrateonly]
== Migration/AsyncPostMigrateOnly

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Ensures that asynchronous index helper methods are only called from post migrations.

[#migrationavoidfinalizebackgroundmigration]
== Migration/AvoidFinalizeBackgroundMigration

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationbackgroundmigrationmissingactiveconcern]
== Migration/BackgroundMigrationMissingActiveConcern

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks `ActiveSupport::Concern` is included in EE batched background migrations
if they define `scope_to`.

[#migrationbackgroundmigrationrecord]
== Migration/BackgroundMigrationRecord

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationbackgroundmigrations]
== Migration/BackgroundMigrations

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationbatchmigrationspostonly]
== Migration/BatchMigrationsPostOnly

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks that no background batched migration helpers are called by regular migrations.

[#migrationbatchedmigrationbaseclass]
== Migration/BatchedMigrationBaseClass

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationchangecolumnnullonhightraffictable]
== Migration/ChangeColumnNullOnHighTrafficTable

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationcomplexindexesrequirename]
== Migration/ComplexIndexesRequireName

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationcreatetablewithforeignkeys]
== Migration/CreateTableWithForeignKeys

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationdatetime]
== Migration/Datetime

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if datetime data type is added with timezone information.

[#migrationdroptable]
== Migration/DropTable

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if `drop_table` is called in deployment migrations.
Calling it in deployment migrations can cause downtimes as there still may be code using the target tables.

[#migrationensurefactoryfortable]
== Migration/EnsureFactoryForTable

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Checks for `create_table` calls without a corresponding factory.

This check is skipped when `ee/` directory is not present.

[#examples-migrationensurefactoryfortable]
=== Examples

[source,ruby]
----
# bad

create_table :users do |t|
  t.string :name
  t.timestamps
end
# spec/factories/users.rb does not exist
----

[source,ruby]
----
# good

create_table :users do |t|
  t.string :name
  t.timestamps
end
# spec/factories/users.rb exists
----

[#migrationmigrationrecord]
== Migration/MigrationRecord

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationmigrationwithmilestone]
== Migration/MigrationWithMilestone

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks that any 2.2+ migration is incldued with a call to 'milestone'

[#migrationpreventglobalenablelockretrieswithdisableddltransaction]
== Migration/PreventGlobalEnableLockRetriesWithDisableDdlTransaction

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that prevents usage of `enable_lock_retries!` within the `disable_ddl_transaction!` method.

[#migrationpreventindexcreation]
== Migration/PreventIndexCreation

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Adding indexes to certain high traffic tables may cause problems,
and caution should be exercised when doing it.
The goal of this rule is raise awareness and start a discussion.
More details can be found in
  - https://gitlab.com/gitlab-org/gitlab/-/issues/332886
  - https://gitlab.com/groups/gitlab-org/-/epics/11543
  - https://gitlab.com/gitlab-org/gitlab/-/issues/460799

[#migrationpreventsinglestatementwithdisableddltransaction]
== Migration/PreventSingleStatementWithDisableDdlTransaction

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that prevents usage of `disable_ddl_transaction!`
if the only statement being called in the migration is :validate_foreign_key.

We do this because PostgreSQL will add an implicit transaction for single
statements. So there's no reason to add the disable_ddl_transaction!.

This cop was introduced to clarify the need for disable_ddl_transaction!
and to avoid bike-shedding and review back-and-forth.

[#migrationpreventstrings]
== Migration/PreventStrings

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that enforces using text instead of the string data type

[#migrationrefertoindexbyname]
== Migration/ReferToIndexByName

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationremovecolumn]
== Migration/RemoveColumn

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if remove_column is used in a regular (not
post-deployment) migration.

[#migrationremoveconcurrentindex]
== Migration/RemoveConcurrentIndex

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if `remove_concurrent_index` is used with `up`/`down` methods
and not `change`.

[#migrationremoveindex]
== Migration/RemoveIndex

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if indexes are removed in a concurrent manner.

[#migrationsaferbooleancolumn]
== Migration/SaferBooleanColumn

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

This cop requires a default value and disallows nulls for boolean
columns on small tables.

In general, this prevents 3-state-booleans.
https://robots.thoughtbot.com/avoid-the-threestate-boolean-problem

In particular, for the `application_settings` table, this ensures that
upgraded installations get a proper default for the new boolean setting.
A developer might otherwise mistakenly assume that a value in
`ApplicationSetting.defaults` is sufficient.

See https://gitlab.com/gitlab-org/gitlab/issues/2750 for more
information.

[#migrationscheduleasync]
== Migration/ScheduleAsync

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationschemaadditionmethodsnopost]
== Migration/SchemaAdditionMethodsNoPost

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks that no schema migration methods are called by post-deployment migrations.

[#migrationsidekiqqueuemigrate]
== Migration/SidekiqQueueMigrate

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if sidekiq_queue_migrate is used in a regular
(not post-deployment) migration.

[#migrationtimestamps]
== Migration/Timestamps

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if 'timestamps' method is called with timezone information.

[#migrationunfinisheddependencies]
== Migration/UnfinishedDependencies

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Checks if there are any unfinished dependent batched bg migrations

[#migrationupdatecolumninbatches]
== Migration/UpdateColumnInBatches

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that checks if a spec file exists for any migration using
`update_column_in_batches`.

[#migrationversionedmigrationclass]
== Migration/VersionedMigrationClass

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationwithlockretriesdisallowedmethod]
== Migration/WithLockRetriesDisallowedMethod

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

No documentation

[#migrationwithlockretrieswithchange]
== Migration/WithLockRetriesWithChange

|===
| Enabled by default | Safe | Supports autocorrection | Version Added | Version Changed

| Enabled
| Yes
| No
| -
| -
|===

Cop that prevents usage of `with_lock_retries` within the `change` method.
